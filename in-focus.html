<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dynamic Ticker 2</title>
  <link rel="stylesheet" href="fonts.css">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      margin: 0;
      padding: 0;
      background: rgb(255, 255, 255);
      color: white;
      font-family: "DIN", "DIN Condensed", "DIN Expanded", "Arial Narrow", Arial, sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #ticker {
      display: flex;
      align-items: center;
      overflow: hidden;
      white-space: nowrap;
      padding: 10px 15px;
      box-sizing: border-box;
      font-size: 24px;
      width: 100vw;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }

    #label {
      font-weight: bold;
      font-style: italic;
      padding-right: 20px;
      flex-shrink: 0;
      text-transform: uppercase;
    }

    #scroll-container {
      overflow: hidden;
      flex: 1;
      margin-left: 5px;
      padding: 5px;
      position: relative;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
      border-radius: 2px;
    }

    #headlines {
      display: inline-block;
      white-space: nowrap;
      text-transform: uppercase;
      font-weight: bold;
    }

    .headline {
      display: inline-block;
      margin: 0 60px;
    }
  </style>
</head>

<body>

  <div id="ticker">
    <div id="label">Latest News</div>
    <div id="scroll-container">
      <span id="headlines">...</span>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code") || "sbr";

    let site = null;
    let refreshTimer = null;
    const REFRESH_MS = 10 * 60 * 1000;

    fetch("data.json")
      .then(response => {
        if (!response.ok) throw new Error("Failed to load data.json: " + response.status);
        return response.json();
      })
      .then(config => {
        site = config[code] || config["sbr"];
        if (!site?.url) throw new Error("No site URL found");

        document.body.style.color = site.color;

        loadHeadlines();
        refreshTimer = setInterval(loadHeadlines, REFRESH_MS);
      })
      .catch(err => {
        console.error(err);
        document.getElementById("headlines").textContent = "Failed to load configuration.";
      });

    async function loadHeadlines() {
      if (!site) return;

      const feedUrl =
        site.url.replace(/\/$/, "") +
        "/latest-videos.xml?cache=" +
        Date.now();

      try {
        const response = await fetch(feedUrl);
        if (!response.ok) throw new Error("Failed to fetch RSS");

        const xmlText = await response.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "application/xml");

        const parsererror = xml.querySelector("parsererror");
        if (parsererror) {
          document.getElementById("headlines").textContent = "Invalid RSS feed.";
          return;
        }

        const items = xml.querySelectorAll("item");
        let titles = [];

        if (items.length) {
          titles = Array.from(items).slice(0, 10).map(i =>
            i.querySelector("title")?.textContent.trim() || "Untitled"
          );
        } else {
          const entries = xml.querySelectorAll("entry");
          titles = Array.from(entries).slice(0, 10).map(e =>
            e.querySelector("title")?.textContent.trim() || "Untitled"
          );
        }

        renderHeadlines(titles);
      } catch (err) {
        console.error("Error loading RSS feed:", err);
        document.getElementById("headlines").textContent = "Failed to load headlines.";
      }
    }

    function renderHeadlines(titlesArray) {
      const headlines = document.getElementById("headlines");
      if (!titlesArray || !titlesArray.length) {
        headlines.innerHTML = "No headlines.";
        headlines.style.animation = "";
        return;
      }

      headlines.innerHTML = titlesArray
        .map(t => `<span class="headline">${escapeHtml(t)}</span>`)
        .join("");

      requestAnimationFrame(() => {
        const container = document.getElementById("scroll-container");
        const contentWidth = headlines.offsetWidth;
        const containerWidth = container.offsetWidth;

        if (contentWidth <= containerWidth) {
          headlines.style.animation = "";
          headlines.style.transform = "translateX(0)";
          return;
        }

        const speed = 200;
        const duration = (contentWidth + containerWidth) / speed;
        const animName = "scrollAnim_" + Date.now();

        document.getElementById("dynamic-scroll-style")?.remove();

        const styleTag = document.createElement("style");
        styleTag.id = "dynamic-scroll-style";
        styleTag.innerHTML = `
          @keyframes ${animName} {
            0% { transform: translateX(${containerWidth}px); }
            100% { transform: translateX(${-contentWidth}px); }
          }
        `;
        document.head.appendChild(styleTag);

        headlines.style.animation = `${animName} ${duration}s linear infinite`;
        headlines.style.willChange = "transform";
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>

</body>

</html>
