<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RSS Headlines Table</title>

<style>
html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background: #f1f1f1;
}

table {
    width: 100%;
    height: 100vh;
    max-height: 100vh;
    border-collapse: collapse;
    table-layout: fixed;
    background: #fff;
}

thead th {
    text-align: center;
    font-size: 24px;
    color: #fff;
    padding: 10px;
}

tbody tr {
    height: 1px; /* overridden dynamically */
}

tbody td {
    padding: 8px 12px;
    font-weight: bold;
    word-break: break-word;
    vertical-align: middle;
}

.tag {
    font-weight: normal;
    font-size: 0.8em;
    color: #555;
    margin-left: 6px;
}
</style>
</head>

<body>

<table>
    <thead>
        <tr>
            <th id="siteHeader">Loadingâ€¦</th>
        </tr>
    </thead>
    <tbody id="rows"></tbody>
</table>

<script>
/* =========================
   PARAMETERS
========================= */
const params = new URLSearchParams(location.search);
const code = params.get("code") || "sbr";
const fontSize = parseInt(params.get("fontSize")) || 18;
const duration = parseInt(params.get("duration")) || 4000;
const numberToDisplay = 15;

/* =========================
   STATE
========================= */
let config;
let headlines = [];
let index = 0;
let timer;

/* =========================
   HELPERS
========================= */
function cacheBust(url) {
    const u = new URL(url);
    u.searchParams.set("cache", Date.now());
    return u.toString();
}

function parsePubDate(text) {
    if (!text) return null;
    const clean = text.replace(/^[A-Za-z]+,\s*/, "").replace(/-\s.*$/, "");
    return new Date(clean);
}

/* =========================
   LOAD CONFIG
========================= */
fetch("data.json")
.then(r => r.json())
.then(c => {
    config = c;
    const site = config[code] || config.sbr;
    setupHeader(site);
    loadFeeds(site);
})
.catch(() => {
    document.getElementById("siteHeader").textContent = "Failed to load";
});

/* =========================
   HEADER
========================= */
function setupHeader(site) {
    const header = document.getElementById("siteHeader");
    header.textContent = site.name || "Site";
    if (site.color) header.style.backgroundColor = site.color;
}

/* =========================
   LOAD FEEDS
========================= */
async function loadFeeds(site) {
    const feeds = [
        { url: site.exclusivesUrl, tag: "Exclusive" },
        { url: site.inFocusUrl, tag: "In Focus" }
    ].filter(f => f.url);

    const map = new Map();
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 7);

    const responses = await Promise.all(
        feeds.map(f => fetch(cacheBust(f.url)).then(r => r.text()))
    );

    responses.forEach((xmlText, i) => {
        const tag = feeds[i].tag;
        const xml = new DOMParser().parseFromString(xmlText, "application/xml");

        xml.querySelectorAll("item").forEach(item => {
            const title = item.querySelector("title")?.textContent?.trim();
            const date = parsePubDate(item.querySelector("pubDate")?.textContent);

            if (!title || !date || date < cutoff) return;

            if (!map.has(title)) {
                map.set(title, { title, date, tags: new Set([tag]) });
            } else {
                map.get(title).tags.add(tag);
            }
        });
    });

    headlines = [...map.values()].sort((a, b) => b.date - a.date);
    index = 0;

    render();
    clearInterval(timer);
    timer = setInterval(render, duration);
}

/* =========================
   RENDER
========================= */
function render() {
    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    const totalSets = Math.ceil(headlines.length / numberToDisplay);
    const currentSet = Math.floor(index / numberToDisplay) + 1;

    const site = config[code] || config.sbr;
    const header = document.getElementById("siteHeader");
    header.textContent = totalSets > 1
        ? `${site.name} (${currentSet}/${totalSets})`
        : site.name;

    const batch = headlines.slice(index, index + numberToDisplay);
    const rowHeight = 100 / numberToDisplay + "%";

    for (let i = 0; i < numberToDisplay; i++) {
        const tr = document.createElement("tr");
        tr.style.height = rowHeight;

        const td = document.createElement("td");
        td.style.fontSize = fontSize + "px";

        if (batch[i]) {
            td.textContent = batch[i].title;
            if (batch[i].tags.size) {
                const span = document.createElement("span");
                span.className = "tag";
                span.textContent = " (" + [...batch[i].tags].join(" & ") + ")";
                td.appendChild(span);
            }
        } else {
            td.innerHTML = "&nbsp;";
        }

        tr.appendChild(td);
        tbody.appendChild(tr);
    }

    index += numberToDisplay;
    if (index >= headlines.length) index = 0;
}
</script>

</body>
</html>