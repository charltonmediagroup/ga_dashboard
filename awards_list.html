<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awards Countdown Grid</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .grid {
            width: 100vw;
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 8px;
            padding: 8px;
        }

        .header {
            font-weight: bold;
            text-align: center;
            background: #eee;
            padding: 8px;
            border-radius: 4px;
        }

        .block {
            height: fit-content;
            padding: 4px;
            display: grid;
            place-items: center;
            font-size: 15px;
            border-bottom: 1px solid #ccc;
        }

        .title {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="grid" id="grid">
        <!-- Column headers -->
        <div class="header">Award Title</div>
        <div class="header">Submission Start</div>
        <div class="header">Submission End</div>
        <div class="header">Award Date</div>
    </div>

    <script>
        const rawFont = new URLSearchParams(window.location.search).get("font-size");
        let font_size = rawFont || "15px";

        function startCountdown(dateString, el, doneText) {
            const target = new Date(dateString).getTime();
            if (isNaN(target)) { el.textContent = doneText; return; }

            function tick() {
                const diff = target - Date.now();
                if (diff <= 0) { el.textContent = doneText; return; }
                const d = Math.floor(diff / 86400000),
                    h = Math.floor(diff / 3600000) % 24,
                    m = Math.floor(diff / 60000) % 60,
                    s = Math.floor(diff / 1000) % 60;
                el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                setTimeout(tick, 1000 - (Date.now() % 1000));
            }
            tick();
        }

        async function loadAllAwards() {
            const config = await fetch("dataAwards.json").then(r => r.json());
            const allAwards = [];

            for (const siteKey in config) {
                const site = config[siteKey];
                if (!site?.url) continue;
                try {
                    const awards = await fetch(site.url + "/node/content-menu/awards.json?cache=false")
                        .then(r => r.json());
                    allAwards.push(...awards);
                } catch (err) {
                    console.warn(`Failed to load awards for ${siteKey}:`, err);
                }
            }

            return allAwards;
        }

        async function fetchNominationDates(award) {
            try {
                const [startDate, endDate] = await Promise.all([
                    fetchNodeDate(award.view_node, "div.nomination-date div.date.start-date"),
                    fetchNodeDate(award.view_node, "div.nomination-date div.date.end-date")
                ]);
                return { ...award, startDate, endDate };
            } catch {
                return { ...award, startDate: null, endDate: null };
            }
        }

        async function fetchNodeDate(url, selector) {
            try {
                const html = await fetch(url).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const nominationEl = doc.querySelector("div.nomination-date");
                if (!nominationEl) return null;
                const el = nominationEl.querySelector(selector.replace("div.nomination-date", ""));
                const raw = el?.getAttribute("date");
                return raw ? new Date(raw).toISOString() : null;
            } catch {
                return null;
            }
        }

        async function renderGrid() {
            const grid = document.getElementById("grid");
            const rawAwards = await loadAllAwards();

            const awards = await Promise.all(rawAwards.map(fetchNominationDates));
            awards.sort((a, b) => new Date(a.field_date) - new Date(b.field_date));

            const now = Date.now();

            awards.forEach(award => {
                const startTime = award.startDate ? new Date(award.startDate).getTime() : null;
                const endTime = award.endDate ? new Date(award.endDate).getTime() : null;
                const awardTime = award.field_date ? new Date(award.field_date).getTime() : null;

                const startError = startTime && endTime && startTime > endTime;
                const endError = endTime && startTime && endTime < startTime;
                const awardError = awardTime && ((startTime && awardTime < startTime) || (endTime && awardTime < endTime));

                const titleDiv = document.createElement("div");
                titleDiv.className = "block title";
                titleDiv.textContent = award.title;
                titleDiv.style.fontSize = font_size;

                const startDiv = document.createElement("div");
                startDiv.className = "block start";
                startDiv.textContent = startError ? "ERROR" : (startTime && startTime <= now ? "Submission Started" : "Submission Start");
                startDiv.style.fontSize = font_size;

                const endDiv = document.createElement("div");
                endDiv.className = "block end";
                endDiv.textContent = endError ? "ERROR" : (endTime && endTime <= now ? "Submission Ended" : "Submission End");
                endDiv.style.fontSize = font_size;

                const awardDiv = document.createElement("div");
                awardDiv.className = "block main";
                awardDiv.textContent = awardError ? "ERROR" : (awardTime && awardTime <= now ? "Awards Ended" : "Award Date");
                awardDiv.style.fontSize = font_size;

                grid.appendChild(titleDiv);
                grid.appendChild(startDiv);
                grid.appendChild(endDiv);
                grid.appendChild(awardDiv);

                if (!startError && startTime) startCountdown(startTime, startDiv, "Submission Started");
                if (!endError && endTime) startCountdown(endTime, endDiv, "Submission Ended");
                if (!awardError && awardTime) startCountdown(awardTime, awardDiv, "Awards Ended");
            });
        }

        renderGrid();
    </script>
</body>

</html>