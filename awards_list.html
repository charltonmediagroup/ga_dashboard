<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Awards Countdown Grid</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 13px;
            overflow: hidden;
        }

        .grid {
            height: 100%;
            width: 100%;
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            gap: 4px;
            padding: 4px;
            box-sizing: border-box;
        }

        .header {
            font-weight: bold;
            text-align: center;
            background: #eee;
            padding: 4px;
            border-radius: 2px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .block {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 4px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .title {
            justify-content: flex-start;
            padding-left: 6px;
        }

        /* subtle row striping */
        .grid div:nth-child(8n+5),
        .grid div:nth-child(8n+6),
        .grid div:nth-child(8n+7),
        .grid div:nth-child(8n+8) {
            background: #fafafa;
        }
    </style>
</head>

<body>
    <div class="grid" id="grid">
        <div class="header">Award Title</div>
        <div class="header">Submission Start</div>
        <div class="header">Submission End</div>
        <div class="header">Award Date</div>
    </div>

    <script>
        /* -------------------- params -------------------- */
        const params = new URLSearchParams(window.location.search);
        const fontSize = params.get("font-size") || "12px";
        const halfParam = params.get("half");

        /* -------------------- utils -------------------- */
        function decodeHtml(str = "") {
            const t = document.createElement("textarea");
            t.innerHTML = str;
            return t.value;
        }

        function startCountdown(targetDate, el, doneText) {
            const target = new Date(targetDate).getTime();
            if (isNaN(target)) {
                el.textContent = doneText;
                return;
            }

            function tick() {
                const diff = target - Date.now();
                if (diff <= 0) {
                    el.textContent = doneText;
                    return;
                }

                const d = Math.floor(diff / 86400000);
                const h = Math.floor(diff / 3600000) % 24;
                const m = Math.floor(diff / 60000) % 60;
                const s = Math.floor(diff / 1000) % 60;

                el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                setTimeout(tick, 1000 - (Date.now() % 1000));
            }

            tick();
        }

        /* -------------------- data loading -------------------- */
        async function loadAllAwards() {
            const config = await fetch("dataAwards.json").then(r => r.json());

            const requests = Object.values(config)
                .filter(site => site?.url)
                .map(site =>
                    fetch(site.url + "/node/content-menu/awards.json?cache=false")
                        .then(r => r.json())
                        .catch(() => [])
                );

            const results = await Promise.all(requests);
            return results.flat();
        }

        async function fetchNodeDate(url, selector) {
            try {
                const html = await fetch(url).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const el = doc.querySelector(selector);
                const raw = el?.getAttribute("date");
                return raw ? new Date(raw).toISOString() : null;
            } catch {
                return null;
            }
        }

        async function enrichAward(award) {
            const [startDate, endDate] = await Promise.all([
                fetchNodeDate(award.view_node, "div.date.start-date"),
                fetchNodeDate(award.view_node, "div.date.end-date")
            ]);

            return { ...award, startDate, endDate };
        }

        /* -------------------- render -------------------- */
        async function renderGrid() {
            const grid = document.getElementById("grid");
            let awards = await loadAllAwards();

            awards = await Promise.all(awards.map(enrichAward));
            awards.sort((a, b) => new Date(a.field_date) - new Date(b.field_date));

            if (halfParam === "first" || halfParam === "second") {
                const mid = Math.ceil(awards.length / 2);
                awards = halfParam === "first"
                    ? awards.slice(0, mid)
                    : awards.slice(mid);
            }

            const now = Date.now();

            awards.forEach(award => {
                const startTime = award.startDate && new Date(award.startDate).getTime();
                const endTime = award.endDate && new Date(award.endDate).getTime();
                const awardTime = award.field_date && new Date(award.field_date).getTime();

                const titleDiv = document.createElement("div");
                titleDiv.className = "block title";
                titleDiv.style.fontSize = fontSize;
                titleDiv.textContent = decodeHtml(award.title);

                const startDiv = document.createElement("div");
                startDiv.className = "block";
                startDiv.style.fontSize = fontSize;
                startDiv.textContent = "Submission Start";

                const endDiv = document.createElement("div");
                endDiv.className = "block";
                endDiv.style.fontSize = fontSize;
                endDiv.textContent = "Submission End";

                const awardDiv = document.createElement("div");
                awardDiv.className = "block";
                awardDiv.style.fontSize = fontSize;
                awardDiv.textContent = "Award Date";

                grid.append(titleDiv, startDiv, endDiv, awardDiv);

                if (startTime) startCountdown(startTime, startDiv, "Submission Started");
                if (endTime) startCountdown(endTime, endDiv, "Submission Ended");
                if (awardTime) startCountdown(awardTime, awardDiv, "Awards Ended");
            });
        }

        renderGrid();
    </script>
</body>

</html>
