<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Awards Countdown Grid</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 13px;
            overflow: hidden;
        }

        .grid {
            height: 100%;
            width: 100%;
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr;
            gap: 4px;
            padding: 4px;
            box-sizing: border-box;
        }

        .header {
            font-weight: bold;
            text-align: center;
            background: white;
            padding: 4px;
            border-radius: 2px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .block {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 4px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .title {
            justify-content: flex-start;
            gap: 6px;
        }

        .title img {
            object-fit: contain;
            flex-shrink: 0;
            border-radius: 2px;
        }

        /* subtle row striping */
        .grid div:nth-child(8n+5),
        .grid div:nth-child(8n+6),
        .grid div:nth-child(8n+7),
        .grid div:nth-child(8n+8) {
            background: #fafafa;
        }
    </style>
</head>

<body>
    <div class="grid" id="grid">
        <div class="header">Award Title</div>
        <div class="header">Submission Start</div>
        <div class="header">Submission End</div>
        <div class="header">Award Date</div>
        <div class="header">Date</div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const fontSize = params.get("font-size") || "12px";
        const imgSize = params.get("img-size") || 32;
        const halfParam = params.get("half");

        // Decode HTML entities
        function decodeHtml(str = "") {
            const t = document.createElement("textarea");
            t.innerHTML = str;
            return t.value;
        }

        // Countdown timer
        function startCountdown(targetDate, el, doneText) {
            const target = new Date(targetDate).getTime();
            if (isNaN(target)) { el.textContent = doneText; return; }

            function tick() {
                const diff = target - Date.now();
                if (diff <= 0) { el.textContent = doneText; return; }
                const d = Math.floor(diff / 86400000);
                const h = Math.floor(diff / 3600000) % 24;
                const m = Math.floor(diff / 60000) % 60;
                const s = Math.floor(diff / 1000) % 60;
                el.textContent = `${d}d ${h}h ${m}m ${s}s`;
                setTimeout(tick, 1000 - (Date.now() % 1000));
            }

            tick();
        }

        function formatDateOnly(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            if (isNaN(d)) return "";
            // Example: "Jan 16, 2026" â€” change options if you prefer another format
            return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
        }


        // Load all awards from config
        async function loadAllAwards() {
            const config = await fetch("dataAwards.json").then(r => r.json());
            const requests = Object.values(config)
                .filter(site => site?.url)
                .map(site => fetch(site.url + "/node/content-menu/awards.json?cache=false")
                    .then(r => r.json())
                    .catch(() => [])
                );
            const results = await Promise.all(requests);
            return results.flat();
        }

        // Fetch start/end dates from the award page
        async function fetchNodeDate(url, selector) {
            try {
                const html = await fetch(url).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const el = doc.querySelector(selector);
                const raw = el?.getAttribute("date");
                return raw ? new Date(raw).toISOString() : null;
            } catch {
                return null;
            }
        }

        async function fetchNominationDates(award) {
            try {
                const [startDate, endDate] = await Promise.all([
                    fetchNodeDate(award.view_node, "div.nomination-date div.date.start-date"),
                    fetchNodeDate(award.view_node, "div.nomination-date div.date.end-date")
                ]);
                return { ...award, startDate, endDate };
            } catch {
                return { ...award, startDate: null, endDate: null };
            }
        }

        async function fetchNodeDate(url, selector) {
            try {
                const html = await fetch(url).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const nominationEl = doc.querySelector("div.nomination-date");
                if (!nominationEl) return null;
                const el = nominationEl.querySelector(selector.replace("div.nomination-date", ""));
                const raw = el?.getAttribute("date");
                return raw ? new Date(raw).toISOString() : null;
            } catch {
                return null;
            }
        }

        // Add start/end dates to award object
        async function enrichAward(award) {
            return fetchNominationDates(award);
        }

        // Fetch images from the award listing page
        async function fetchAwardImagesMap(siteUrl) {
            try {
                const html = await fetch(`${siteUrl}/awards`).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const items = Array.from(doc.querySelectorAll('.view-content .item.with-border-bottom'));
                const map = {};
                items.forEach(item => {
                    const linkEl = item.querySelector('.item__title a');
                    const imgEl = item.querySelector('img.lazyload, img.lazyloaded');
                    if (linkEl && imgEl) {
                        const url = linkEl.href.trim(); // Use URL as key
                        const imgUrl = imgEl.getAttribute('data-srcset')?.split(' ')[0] || imgEl.src;
                        map[url] = imgUrl;
                    }
                });
                return map;
            } catch (e) {
                console.warn("Failed to fetch award images map:", e);
                return {};
            }
        }

        // Render the grid
        async function renderGrid() {
            const grid = document.getElementById("grid");
            let awards = await loadAllAwards();
            awards = await Promise.all(awards.map(enrichAward));
            awards.sort((a, b) => new Date(a.field_date) - new Date(b.field_date));

            // Half parameter support
            if (halfParam === "first" || halfParam === "second" || halfParam === "third" || halfParam === "fourth") {
                const mid = Math.ceil(awards.length / 2); awards = halfParam === "first" ? awards.slice(0, mid) : awards.slice(mid);
            }

            // Fetch images for all sites
            const config = await fetch("dataAwards.json").then(r => r.json());
            const imageMaps = await Promise.all(Object.values(config)
                .filter(site => site?.url)
                .map(site => fetchAwardImagesMap(site.url))
            );
            const allImagesMap = Object.assign({}, ...imageMaps);

            // Render each award
            awards.forEach(award => {
                const startTime = award.startDate && new Date(award.startDate).getTime();
                const endTime = award.endDate && new Date(award.endDate).getTime();
                const awardTime = award.field_date && new Date(award.field_date).getTime();
                if (awardTime && awardTime < Date.now()) return;

                const customTDMImage = "https://www.cmgassets.com/s3fs-public/styles/awards/public/2025-04/tdm-indonesia.png.webp?itok=Bia_KDVA"; // <-- replace with your image URL

                // Title with image (matched by view_node URL)
                const titleDiv = document.createElement("div");
                titleDiv.className = "block title";
                titleDiv.style.fontSize = fontSize;

                const img = document.createElement("img");

                img.style.width = img.style.height = imgSize + "px";

                // Use custom image if title starts with "TDM"
                if (award.title.trim().startsWith("TDM")) {
                    img.src = customTDMImage;
                } else {
                    img.src = allImagesMap[award.view_node] || "";
                }

                img.alt = award.title;

                const span = document.createElement("span");
                span.textContent = decodeHtml(award.title);

                titleDiv.appendChild(img);
                titleDiv.appendChild(span);
                ;

                // Other columns
                const startDiv = document.createElement("div");
                startDiv.className = "block";
                startDiv.style.fontSize = fontSize;
                startDiv.textContent = "Submission Start";

                const endDiv = document.createElement("div");
                endDiv.className = "block";
                endDiv.style.fontSize = fontSize;
                endDiv.textContent = "Submission End";

                const awardDiv = document.createElement("div");
                awardDiv.className = "block";
                awardDiv.style.fontSize = fontSize;
                awardDiv.textContent = "Award Date";

                const awardDateDiv = document.createElement("div");
                awardDateDiv.className = "block";
                awardDateDiv.style.fontSize = fontSize;
                awardDateDiv.textContent = award.field_date ? formatDateOnly(award.field_date) : "";

                grid.append(titleDiv, startDiv, endDiv, awardDiv, awardDateDiv);

                if (startTime) startCountdown(startTime, startDiv, "Submission Started");
                if (endTime) startCountdown(endTime, endDiv, "Submission Ended");
                if (awardTime) startCountdown(awardTime, awardDiv, "Awards Ended");
            });
        }

        renderGrid();
    </script>
</body>

</html>