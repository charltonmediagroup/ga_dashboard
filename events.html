<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Events News</title>
  <link rel="stylesheet" href="fonts.css">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      margin: 0;
      padding: 0;
      color: white;
      font-family: "DIN", "DIN Condensed", "DIN Expanded", "Arial Narrow", Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #ticker {
      display: flex;
      align-items: center;
      overflow: hidden;
      white-space: nowrap;
      box-sizing: border-box;
      font-size: 26px;
      width: 100vw;
      height: 100%;
    }

    #label {
      font-weight: bold;
      flex-shrink: 0;
      text-transform: uppercase;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.501);
      background-color: #074782;
      text-align: center;
      height: 100%;
      width: 170px;
      align-content: center;
    }

    #scroll-container {
      overflow: hidden;
      flex: 1;
      position: relative;
      background-color: red;
      height: 100%;
      align-content: center;
    }

    #headlines {
      display: inline-block;
      white-space: nowrap;
      text-transform: uppercase;
      font-weight: bold;
    }

    .headline {
      display: inline-block;
      margin: 0 60px;
    }
  </style>
</head>

<body>

  <div id="ticker">
    <div id="label">Events News</div>
    <div id="scroll-container">
      <span id="headlines"></span>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code") || "sbr";
    const isColorTheme = params.get("theme-color");

    let site = null;
    let refreshTimer = null;
    const REFRESH_MS = 10 * 60 * 1000;

    fetch("data.json")
      .then(res => {
        if (!res.ok) throw new Error("Failed to load data.json");
        return res.json();
      })
      .then(config => {
        site = config[code] || config["sbr"];
        if (!site?.url) throw new Error("No site URL found");

        if (String(isColorTheme).toLowerCase() === "true" || isColorTheme === "1") {
          document.getElementById("scroll-container").style.backgroundColor = site.color;
        }

        loadHeadlines();
        refreshTimer = setInterval(loadHeadlines, REFRESH_MS);
      })
      .catch(err => {
        console.error(err);
        document.getElementById("headlines").textContent = "Failed to load configuration.";
      });

    async function loadHeadlines() {
      if (!site) return;

      const feedUrl =
        site.url.replace(/\/$/, "") +
        "/news-feed.xml?cache=" +
        Date.now();

      try {
        const response = await fetch(feedUrl);
        if (!response.ok) throw new Error("Failed to fetch RSS");

        const xmlText = await response.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "application/xml");

        if (xml.querySelector("parsererror")) {
          document.getElementById("headlines").textContent = "Invalid RSS feed.";
          return;
        }

        const items = xml.querySelectorAll("item");
        let titles = [];

        if (items.length) {
          titles = Array.from(items).slice(0, 10).map(i =>
            i.querySelector("title")?.textContent.trim() || "Untitled"
          );
        } else {
          const entries = xml.querySelectorAll("entry");
          titles = Array.from(entries).slice(0, 10).map(e =>
            e.querySelector("title")?.textContent.trim() || "Untitled"
          );
        }

        renderHeadlines(titles);
      } catch (err) {
        console.error(err);
        document.getElementById("headlines").textContent = "Failed to load headlines.";
      }
    }

    function renderHeadlines(titlesArray) {
      const headlines = document.getElementById("headlines");

      if (!titlesArray.length) {
        headlines.textContent = "No headlines.";
        headlines.style.animation = "";
        return;
      }

      headlines.innerHTML = titlesArray
        .map(t => `<span class="headline">${escapeHtml(t)}</span>`)
        .join("");

      requestAnimationFrame(() => {
        const container = document.getElementById("scroll-container");
        const contentWidth = headlines.offsetWidth;
        const containerWidth = container.offsetWidth;

        if (contentWidth <= containerWidth) {
          headlines.style.animation = "";
          headlines.style.transform = "translateX(0)";
          return;
        }

        const speed = params.get("speed") || 75;
        const duration = (contentWidth + containerWidth) / speed;
        const animName = "scrollAnim_" + Date.now();

        document.getElementById("dynamic-scroll-style")?.remove();

        const styleTag = document.createElement("style");
        styleTag.id = "dynamic-scroll-style";
        styleTag.innerHTML = `
          @keyframes ${animName} {
            0% { transform: translateX(${containerWidth}px); }
            100% { transform: translateX(${-contentWidth}px); }
          }
        `;
        document.head.appendChild(styleTag);

        headlines.style.animation = `${animName} ${duration}s linear infinite`;
        headlines.style.willChange = "transform";
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>

</body>

</html>
