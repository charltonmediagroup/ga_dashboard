<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awards Countdown Grid</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .grid {
            width: 100vw;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            align-items: start;
        }

        .card {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
        }

        .block {
            text-align: left;
            font-size: 15px;
        }

        .block .label {
            font-weight: 600;
        }

        .block .value {
            margin-top: 2px;
            font-weight: normal;
        }

        .img-wrap {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            overflow: visible;
        }

        .img-wrap img {
            max-width: min(100%, 500px);
            max-height: min(180px, 40vh);
            height: auto;
        }
    </style>
</head>

<body>
    <div class="grid" id="grid"></div>
    <script>
        /* =============================
           CONFIG â€“ PUT YOUR URL HERE
        ============================== */
        const SITE_URL = "https://qsrmedia.com.au/"; // <-- CHANGE THIS

        const image_size = 100;
        const font_size = "25px";

        function startCountdown(dateString, el, doneText) {
            const target = new Date(dateString).getTime();
            if (isNaN(target)) {
                el.querySelector(".value").textContent = doneText;
                return;
            }

            function tick() {
                const diff = target - Date.now();
                const valueEl = el.querySelector(".value");

                if (diff <= 0) {
                    valueEl.textContent = doneText;
                    return;
                }

                const d = Math.floor(diff / 86400000),
                    h = Math.floor(diff / 3600000) % 24,
                    m = Math.floor(diff / 60000) % 60,
                    s = Math.floor(diff / 1000) % 60;

                valueEl.textContent = `${d}d ${h}h ${m}m ${s}s`;
                setTimeout(tick, 1000 - (Date.now() % 1000));
            }

            tick();
        }

        async function loadAwards() {
            const awards = await fetch(
                SITE_URL + "/node/content-menu/awards.json?cache=false"
            ).then(r => r.json());

            return { siteUrl: SITE_URL, awards };
        }

        async function fetchAwardImagesMap(siteUrl) {
            try {
                const html = await fetch(`${siteUrl}/awards`).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const items = Array.from(doc.querySelectorAll('.view-content .item.with-border-bottom'));
                const map = {};

                items.forEach(item => {
                    const linkEl = item.querySelector('.item__title a');
                    const imgEl = item.querySelector('img.lazyload, img.lazyloaded');
                    if (linkEl && imgEl) {
                        const url = linkEl.href.trim();
                        const title = linkEl.textContent.trim();
                        const imgUrl =
                            imgEl.getAttribute('data-srcset')?.split(' ')[0] || imgEl.src;
                        map[url] = { imgUrl, title };
                    }
                });

                return map;
            } catch (e) {
                console.warn("Failed to fetch award images map:", e);
                return {};
            }
        }

        async function fetchNodeDate(url, selector) {
            try {
                const html = await fetch(url).then(r => r.text());
                const doc = new DOMParser().parseFromString(html, "text/html");
                const nominationEl = doc.querySelector("div.nomination-date");
                if (!nominationEl) return null;

                const el = nominationEl.querySelector(
                    selector.replace("div.nomination-date", "")
                );
                const raw = el?.getAttribute("date");
                return raw ? new Date(raw).toISOString() : null;
            } catch {
                return null;
            }
        }

        async function fetchNominationDates(award) {
            try {
                const [startDate, endDate] = await Promise.all([
                    fetchNodeDate(award.view_node, "div.nomination-date div.date.start-date"),
                    fetchNodeDate(award.view_node, "div.nomination-date div.date.end-date")
                ]);
                return { ...award, startDate, endDate };
            } catch {
                return { ...award, startDate: null, endDate: null };
            }
        }

        async function renderGrid() {
            const grid = document.getElementById("grid");
            const { siteUrl, awards: rawAwards } = await loadAwards();
            const imageMap = await fetchAwardImagesMap(siteUrl);

            const awards = await Promise.all(
                rawAwards.map(async award => {
                    const data = await fetchNominationDates(award);
                    const imgData =
                        imageMap[award.view_node] ||
                        Object.values(imageMap).find(x => x.title === award.title);

                    data.imgUrl = imgData?.imgUrl || "";
                    return data;
                })
            );

            awards.sort((a, b) => new Date(a.field_date) - new Date(b.field_date));

            awards.forEach(award => {
                const card = document.createElement("div");
                card.className = "card";

                function createBlock(labelText) {
                    const block = document.createElement("div");
                    block.className = "block";
                    block.style.fontSize = font_size;

                    const label = document.createElement("div");
                    label.className = "label";
                    label.textContent = labelText;

                    const value = document.createElement("div");
                    value.className = "value";

                    block.appendChild(label);
                    block.appendChild(value);
                    return block;
                }

                const imgWrap = document.createElement("div");
                imgWrap.className = "img-wrap";

                const img = document.createElement("img");
                img.src = award.imgUrl;
                img.alt = award.title;
                img.style.maxWidth = image_size + "%";
                img.style.height = "auto";

                imgWrap.appendChild(img);

                const startBlock = createBlock("Nomination Opens:");
                const endBlock = createBlock("Nomination Closes:");
                const awardBlock = createBlock("Awards Presentation:");

                card.appendChild(imgWrap);
                card.appendChild(startBlock);
                card.appendChild(endBlock);
                card.appendChild(awardBlock);
                grid.appendChild(card);

                if (award.startDate)
                    startCountdown(award.startDate, startBlock, "Nomination Opened");
                if (award.endDate)
                    startCountdown(award.endDate, endBlock, "Nomination Closed");
                if (award.field_date)
                    startCountdown(award.field_date, awardBlock, "Awards Presentation Finished");
            });
        }

        renderGrid();
    </script>
</body>

</html>